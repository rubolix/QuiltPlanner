<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QuiltPlanner ‚Äî Fabric Calculator & Layout Planner</title>
<style>
:root {
  --bg: #faf8f5;
  --surface: #ffffff;
  --border: #e0ddd8;
  --accent: #c87941;
  --accent2: #7a9e7e;
  --teal: #5b8a8a;
  --sage: #9caf88;
  --text: #3a3632;
  --muted: #8a847d;
  --radius: 8px;
  --shadow: 0 1px 3px rgba(0,0,0,0.08);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
h1 { font-size: 1.8rem; padding: 24px; text-align: center; color: var(--teal); }
h1 span { color: var(--accent); }

.app { max-width: 1400px; margin: 0 auto; padding: 0 20px 40px; }

.grid { display: grid; grid-template-columns: 400px 1fr; gap: 24px; align-items: start; }
@media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

.panel { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow); }
.panel h2 { font-size: 1rem; margin-bottom: 16px; color: var(--teal); }

label { display: block; font-size: 0.85rem; color: var(--muted); margin-bottom: 4px; margin-top: 12px; }
label:first-child { margin-top: 0; }
input, select { width: 100%; padding: 8px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-size: 0.95rem; }
input:focus, select:focus { outline: none; border-color: var(--teal); }
input[type="checkbox"] { width: auto; margin-right: 6px; accent-color: var(--teal); }

.row { display: flex; gap: 10px; }
.row > * { flex: 1; }

.btn { padding: 10px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.15s; }
.btn:hover { opacity: 0.85; }
.btn-accent { background: var(--accent); color: #fff; }
.btn-green { background: var(--teal); color: #fff; }
.btn-sage { background: var(--sage); color: #fff; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
.btn-outline:hover { border-color: var(--teal); color: var(--teal); }
.btn-sm { padding: 6px 10px; font-size: 0.8rem; }
.btn-danger { background: #c0392b; color: #fff; }
.btn-edit { background: transparent; border: 1px solid var(--border); color: var(--muted); }
.btn-edit:hover { border-color: var(--teal); color: var(--teal); }

.actions { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }

.presets { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
.preset { padding: 4px 10px; font-size: 0.8rem; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); cursor: pointer; transition: all 0.15s; }
.preset:hover, .preset.active { border-color: var(--accent); color: var(--accent); background: #fdf5ee; }

.stats { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px; }
.stat { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px 14px; text-align: center; flex: 1; min-width: 100px; box-shadow: var(--shadow); }
.stat .val { font-size: 1.4rem; font-weight: 700; color: var(--accent); }
.stat .lbl { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }

.piece-item { display: flex; align-items: center; gap: 8px; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 6px; font-size: 0.9rem; transition: border-color 0.15s; }
.piece-item:hover { border-color: var(--teal); }
.piece-item .swatch { width: 16px; height: 16px; border-radius: 3px; flex-shrink: 0; border: 1px solid rgba(0,0,0,0.15); }
.piece-item .dims { flex: 1; }
.piece-item .piece-name { font-size: 0.8rem; color: var(--teal); }

.piece-edit-form { background: #f0ede8; border: 2px solid var(--teal); border-radius: 6px; padding: 12px; margin-bottom: 6px; }
.piece-edit-form .row { margin-bottom: 8px; }

.fabric-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 0.85rem; }
.fabric-table th { text-align: left; padding: 8px; border-bottom: 2px solid var(--border); color: var(--teal); font-weight: 600; }
.fabric-table td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
.fabric-table tr:hover td { background: rgba(0,0,0,0.02); }

.canvas-wrap { background: var(--bg); border-radius: var(--radius); border: 1px solid var(--border); padding: 12px; overflow: auto; }
canvas { display: block; margin: 0 auto; }

.import-export-group { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border); }
.import-export-group .btn { font-size: 0.78rem; padding: 6px 10px; }

.modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; }
.modal-overlay.active { display: flex; }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; max-width: 560px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.15); }
.modal h3 { color: var(--teal); margin-bottom: 12px; }
.modal textarea { width: 100%; min-height: 140px; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); font-family: monospace; font-size: 0.85rem; resize: vertical; }
.modal .actions { margin-top: 16px; }

.empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }
.empty-state p { margin-top: 8px; font-size: 0.9rem; }

.color-input-wrap { display: flex; gap: 8px; align-items: center; }
.color-input-wrap input[type="color"] { width: 36px; height: 36px; padding: 2px; cursor: pointer; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); }
.color-input-wrap input[type="text"] { flex: 1; }

.section-divider { border: none; border-top: 1px solid var(--border); margin: 16px 0; }

.tip { font-size: 0.78rem; color: var(--muted); margin-top: 4px; font-style: italic; }

.example-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.example-grid .btn { text-align: center; }

.waste-note { font-size: 0.8rem; color: var(--accent); margin-top: 8px; padding: 8px; background: #fdf5ee; border-radius: 4px; border: 1px solid #f0d9c0; }

footer { text-align: center; padding: 20px; color: var(--muted); font-size: 0.8rem; }
footer a { color: var(--teal); }

@media print {
  body { background: #fff !important; color: #000 !important; font-size: 11pt; }
  .no-print, #importModal, .modal { display: none !important; }
  .panel { background: #fff !important; border: 1px solid #ccc !important; break-inside: avoid; box-shadow: none !important; margin-bottom: 12px; }
  .stat { background: #f5f5f5 !important; box-shadow: none !important; }
  .stat .val { color: #333 !important; }
  .stat .lbl { color: #666 !important; }
  .fabric-table th { color: #333 !important; border-bottom-color: #ccc !important; }
  .fabric-table td { border-bottom-color: #eee !important; color: #000 !important; }
  canvas { max-width: 100% !important; }
  .grid { display: block !important; }
  h1 { font-size: 18pt; margin-bottom: 4px; }
  @page { margin: 0.5in; }
}
</style>
</head>
<body>
<h1>üßµ Quilt<span>Planner</span></h1>
<div class="app">
<div class="grid">

<!-- LEFT PANEL -->
<div>

<!-- Quilt Settings -->
<div class="panel no-print">
  <h2>üìê Quilt Settings</h2>
  <label>Quilt Size Preset</label>
  <div class="presets" id="sizePresets"></div>
  <div class="row">
    <div><label>Width (in)</label><input type="number" id="quiltW" value="50" min="1"></div>
    <div><label>Height (in)</label><input type="number" id="quiltH" value="65" min="1"></div>
  </div>
  <div class="row">
    <div><label>Block Size (in)</label><input type="number" id="blockSize" value="12" min="1" max="36" step="0.5"></div>
    <div><label>Seam Allowance (in)</label><input type="number" id="seamAllowance" value="0.25" min="0" max="1" step="0.125"></div>
  </div>
  <div class="row">
    <div><label>WOF ‚Äî Width of Fabric (in)</label><input type="number" id="wof" value="42" min="1"></div>
    <div><label>Waste Margin (%)</label><input type="number" id="wasteMargin" value="10" min="0" max="50" step="5"></div>
  </div>
  <p class="tip">üí° WOF is the usable width of your fabric (usually 42‚Ä≥ for quilting cotton).</p>
  <hr class="section-divider">
  <h2>üî≤ Sashing & Borders</h2>
  <div class="row">
    <div>
      <label>Sashing Width</label>
      <input type="number" id="sashW" value="0" min="0" max="6" step="0.25">
    </div>
    <div>
      <label>Sashing Fabric</label>
      <div class="color-input-wrap">
        <input type="color" id="sashColor" value="#e8e0d4">
        <input type="text" id="sashFabricName" value="Sashing" placeholder="Name">
      </div>
    </div>
  </div>
  <div class="row">
    <div>
      <label>Border Width</label>
      <input type="number" id="borderW" value="0" min="0" max="12" step="0.25">
    </div>
    <div>
      <label>Border Fabric</label>
      <div class="color-input-wrap">
        <input type="color" id="borderColor" value="#5b8a8a">
        <input type="text" id="borderFabricName" value="Border" placeholder="Name">
      </div>
    </div>
  </div>
  <div class="row">
    <div>
      <label>Binding Width</label>
      <input type="number" id="bindingW" value="2.5" min="0" max="4" step="0.25">
    </div>
    <div>
      <label>Binding Fabric</label>
      <div class="color-input-wrap">
        <input type="color" id="bindingColor" value="#3a3632">
        <input type="text" id="bindingFabricName" value="Binding" placeholder="Name">
      </div>
    </div>
  </div>
  <p class="tip">üí° Standard binding is 2¬Ω‚Ä≥ strips cut on WOF, joined for the perimeter.</p>
  <label><input type="checkbox" id="calcBacking" checked> Include backing calculation (quilt + 4‚Ä≥ per side)</label>
</div>

<!-- Block Designer -->
<div class="panel no-print">
  <h2>üß© Block Designer</h2>
  <p style="font-size:0.82rem;color:var(--muted);margin-bottom:12px;">Define the pieces in one block. The block repeats across the quilt grid.</p>
  <label>Piece Type</label>
  <div style="display:flex;align-items:center;gap:10px;">
    <select id="pieceType" style="flex:1;">
      <option value="square">Square</option>
      <option value="rect">Rectangle</option>
      <option value="hst">Half-Square Triangle (HST)</option>
      <option value="qst">Quarter-Square Triangle (QST)</option>
      <option value="flygeese">Flying Geese</option>
      <option value="strip">Strip Set</option>
      <option value="circle">Appliqu√© Circle</option>
    </select>
    <canvas id="pieceTypePreview" width="56" height="56" style="border:1px solid var(--border);border-radius:6px;background:#fff;flex-shrink:0;"></canvas>
  </div>
  <div id="pieceDimFields">
    <div class="row">
      <div><label>Finished Size (in)</label><input type="number" id="pieceFinW" value="3" min="0.5" step="0.25"></div>
      <div id="pieceFinHWrap" style="display:none;"><label>Height (in)</label><input type="number" id="pieceFinH" value="3" min="0.5" step="0.25"></div>
    </div>
  </div>
  <label>Quantity per Block</label>
  <input type="number" id="pieceQty" value="1" min="1" max="100">
  <label>Fabric</label>
  <div class="color-input-wrap">
    <input type="color" id="pieceColor" value="#c87941">
    <input type="text" id="pieceFabricName" value="Fabric A" placeholder="Fabric name">
  </div>
  <div id="hstFabric2" style="display:none;">
    <label>HST Second Fabric</label>
    <div class="color-input-wrap">
      <input type="color" id="pieceColor2" value="#9caf88">
      <input type="text" id="pieceFabricName2" value="Fabric B" placeholder="Second fabric name">
    </div>
  </div>
  <div class="actions">
    <button class="btn btn-accent" onclick="addPiece()">+ Add Piece</button>
    <button class="btn btn-outline" onclick="clearPieces()">Clear All</button>
    <button class="btn btn-outline" onclick="randomizeColors()" title="Shuffle fabric colors across existing pieces">üé≤ Randomize Colors</button>
  </div>
  <div id="piecesList" style="margin-top:12px;"></div>
  <p class="tip" id="pieceTip">üí° HSTs are cut from squares ‚Öû‚Ä≥ larger than finished size, yielding 2 triangles per square.</p>
</div>

<!-- Actions -->
<div class="panel no-print">
  <div class="actions" style="margin-top:0;">
    <button class="btn btn-green" onclick="calculate()" style="flex:1;">‚ö° Calculate Yardage</button>
  </div>
  <hr class="section-divider">
  <label style="margin-top:0;">Load Example Project</label>
  <div class="example-grid">
    <button class="btn btn-outline btn-sm" onclick="loadExample('ninepatch')">Nine Patch</button>
    <button class="btn btn-outline btn-sm" onclick="loadExample('pinwheel')">Pinwheel</button>
    <button class="btn btn-outline btn-sm" onclick="loadExample('star')">Sawtooth Star</button>
    <button class="btn btn-outline btn-sm" onclick="loadExample('railfence')">Rail Fence</button>
    <button class="btn btn-outline btn-sm" onclick="loadExample('logcabin')">Log Cabin</button>
    <button class="btn btn-outline btn-sm" onclick="loadExample('irishchain')">Irish Chain</button>
    <button class="btn btn-outline btn-sm" onclick="loadExample('bowtie')">Bow Tie</button>
    <button class="btn btn-outline btn-sm" onclick="loadExample('churn')">Churn Dash</button>
    <button class="btn btn-outline btn-sm" onclick="loadExample('bear')">Bear's Paw</button>
    <button class="btn btn-outline btn-sm" onclick="loadExample('ohio')">Ohio Star</button>
    <button class="btn btn-outline btn-sm" onclick="loadExample('kaleidoscope')">Kaleidoscope (QST)</button>
    <button class="btn btn-outline btn-sm" onclick="loadExample('stripgarden')">Strip Garden</button>
    <button class="btn btn-outline btn-sm" onclick="loadExample('modernapplique')">Modern Appliqu√©</button>
  </div>
  <div class="import-export-group">
    <button class="btn btn-outline" onclick="exportJSON()">üìã Export JSON</button>
    <button class="btn btn-outline" onclick="exportPDF()">üìÑ Print / PDF</button>
    <button class="btn btn-outline" onclick="showImportModal()">üì• Import JSON</button>
    <button class="btn btn-outline" onclick="window.print()">üñ® Print</button>
  </div>
</div>
</div>

<!-- RIGHT PANEL -->
<div>
<div id="resultArea">
  <div class="panel">
    <div class="empty-state">
      <h2>üßµ</h2>
      <p>Add pieces to your block, then click <strong>‚ö° Calculate Yardage</strong></p>
      <p style="margin-top:12px;">Or load an example to get started!</p>
    </div>
  </div>
</div>
</div>

</div><!-- /grid -->
</div><!-- /app -->

<footer class="no-print">QuiltPlanner ‚Äî <a href="https://github.com/rubolix/QuiltPlanner">GitHub</a></footer>

<!-- Import Modal -->
<div class="modal-overlay" id="importModal">
  <div class="modal">
    <h3>üì• Import Project (JSON)</h3>
    <textarea id="importData" placeholder='Paste exported JSON here...'></textarea>
    <div id="importError" style="color:#c0392b;font-size:0.85rem;margin-top:8px;"></div>
    <div class="actions">
      <button class="btn btn-green" onclick="doImport()">Import</button>
      <button class="btn btn-outline" onclick="closeImportModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <h3>‚úèÔ∏è Edit Piece</h3>
    <label>Piece Type</label>
    <select id="editType" onchange="onEditTypeChange()">
      <option value="square">Square</option>
      <option value="rect">Rectangle</option>
      <option value="hst">Half-Square Triangle (HST)</option>
      <option value="qst">Quarter-Square Triangle (QST)</option>
      <option value="flygeese">Flying Geese</option>
      <option value="strip">Strip Set</option>
      <option value="circle">Appliqu√© Circle</option>
    </select>
    <div class="row">
      <div><label>Finished Width (in)</label><input type="number" id="editFinW" min="0.5" step="0.25"></div>
      <div id="editFinHWrap"><label>Height (in)</label><input type="number" id="editFinH" min="0.5" step="0.25"></div>
    </div>
    <label>Quantity per Block</label>
    <input type="number" id="editQty" min="1" max="100">
    <label>Fabric</label>
    <div class="color-input-wrap">
      <input type="color" id="editColor">
      <input type="text" id="editName" placeholder="Fabric name">
    </div>
    <div id="editHst2">
      <label>HST Second Fabric</label>
      <div class="color-input-wrap">
        <input type="color" id="editColor2">
        <input type="text" id="editName2" placeholder="Second fabric">
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-green" onclick="saveEdit()">Save</button>
      <button class="btn btn-outline" onclick="closeEditModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let blockPieces = [];
let editingIndex = -1;

const SIZE_PRESETS = [
  { label: 'Baby', w: 36, h: 52 },
  { label: 'Throw', w: 50, h: 65 },
  { label: 'Twin', w: 68, h: 90 },
  { label: 'Full', w: 80, h: 90 },
  { label: 'Queen', w: 88, h: 96 },
  { label: 'King', w: 105, h: 96 },
];

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
function init() {
  const presetContainer = document.getElementById('sizePresets');
  presetContainer.innerHTML = SIZE_PRESETS.map(p =>
    `<button class="preset" onclick="applyPreset(${p.w},${p.h},this)">${p.label} (${p.w}√ó${p.h})</button>`
  ).join('') + `<button class="preset" onclick="applyPreset(0,0,this)">Custom</button>`;

  document.getElementById('pieceType').addEventListener('change', onPieceTypeChange);
  onPieceTypeChange();
}

function applyPreset(w, h, el) {
  if (w > 0) {
    document.getElementById('quiltW').value = w;
    document.getElementById('quiltH').value = h;
  }
  document.querySelectorAll('.preset').forEach(e => e.classList.remove('active'));
  if (el) el.classList.add('active');
}

function onPieceTypeChange() {
  const type = document.getElementById('pieceType').value;
  document.getElementById('pieceFinHWrap').style.display = (type === 'rect' || type === 'flygeese' || type === 'strip') ? '' : 'none';
  document.getElementById('hstFabric2').style.display = (type === 'hst' || type === 'qst') ? '' : 'none';
  const tips = {
    square: 'üí° Squares are cut at finished size + ¬Ω‚Ä≥ (two seam allowances).',
    rect: 'üí° Rectangles are cut at finished size + ¬Ω‚Ä≥ in each dimension.',
    hst: 'üí° HSTs are cut from squares ‚Öû‚Ä≥ larger than finished size, yielding 2 triangles per square.',
    qst: 'üí° QSTs are cut from squares 1¬º‚Ä≥ larger than finished, cut ‚ï≥ to yield 4 quarter-triangles.',
    flygeese: 'üí° Flying Geese use the "no-waste" method: 1 large square (cut ‚ï≥) + 4 small squares.',
    strip: 'üí° Strip sets: cut full-width strips, sew together, then sub-cut into segments.',
    circle: 'üí° Appliqu√© circles: cut square large enough to contain circle + turn-under allowance.'
  };
  document.getElementById('pieceTip').textContent = tips[type] || '';
  if (type === 'flygeese') {
    document.getElementById('pieceFinH').value = document.getElementById('pieceFinW').value / 2;
  }
  if (type === 'strip') {
    document.getElementById('pieceFinH').value = 2.5;
  }
  drawPieceTypePreview(type);
}

function drawPieceTypePreview(type) {
  const canvas = document.getElementById('pieceTypePreview');
  if (!canvas) return;
  const sz = 56;
  canvas.width = sz; canvas.height = sz;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, sz, sz);
  const m = 6, w = sz - 2*m, h = sz - 2*m;
  const c1 = '#5b8a8a', c2 = '#c87941', bg = '#f0ede8';

  switch (type) {
    case 'square':
      ctx.fillStyle = c1;
      ctx.fillRect(m, m, w, h);
      break;
    case 'rect':
      ctx.fillStyle = c1;
      ctx.fillRect(m, m + h*0.15, w, h*0.7);
      break;
    case 'hst':
      ctx.fillStyle = c1;
      ctx.beginPath(); ctx.moveTo(m, m); ctx.lineTo(m+w, m); ctx.lineTo(m, m+h); ctx.closePath(); ctx.fill();
      ctx.fillStyle = c2;
      ctx.beginPath(); ctx.moveTo(m+w, m); ctx.lineTo(m+w, m+h); ctx.lineTo(m, m+h); ctx.closePath(); ctx.fill();
      ctx.strokeStyle = '#fff'; ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.moveTo(m, m+h); ctx.lineTo(m+w, m); ctx.stroke();
      break;
    case 'qst': {
      const cx = m+w/2, cy = m+h/2;
      ctx.fillStyle = c1;
      ctx.beginPath(); ctx.moveTo(m, m); ctx.lineTo(cx, cy); ctx.lineTo(m, m+h); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(m+w, m); ctx.lineTo(cx, cy); ctx.lineTo(m+w, m+h); ctx.closePath(); ctx.fill();
      ctx.fillStyle = c2;
      ctx.beginPath(); ctx.moveTo(m, m); ctx.lineTo(m+w, m); ctx.lineTo(cx, cy); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(m, m+h); ctx.lineTo(m+w, m+h); ctx.lineTo(cx, cy); ctx.closePath(); ctx.fill();
      ctx.strokeStyle = '#fff'; ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.moveTo(m, m); ctx.lineTo(m+w, m+h); ctx.moveTo(m+w, m); ctx.lineTo(m, m+h); ctx.stroke();
      break;
    }
    case 'flygeese':
      ctx.fillStyle = c1;
      ctx.beginPath(); ctx.moveTo(m+w/2, m); ctx.lineTo(m+w, m+h); ctx.lineTo(m, m+h); ctx.closePath(); ctx.fill();
      ctx.fillStyle = bg;
      ctx.beginPath(); ctx.moveTo(m, m); ctx.lineTo(m+w/2, m); ctx.lineTo(m, m+h); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(m+w/2, m); ctx.lineTo(m+w, m); ctx.lineTo(m+w, m+h); ctx.closePath(); ctx.fill();
      ctx.strokeStyle = '#fff'; ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.moveTo(m, m+h); ctx.lineTo(m+w/2, m); ctx.lineTo(m+w, m+h); ctx.stroke();
      break;
    case 'strip':
      for (let i = 0; i < 4; i++) {
        ctx.fillStyle = [c1, c2, '#9caf88', bg][i];
        ctx.fillRect(m, m + i*h/4, w, h/4 - 1);
      }
      break;
    case 'circle':
      ctx.fillStyle = bg;
      ctx.fillRect(m, m, w, h);
      ctx.fillStyle = c1;
      ctx.beginPath(); ctx.arc(m+w/2, m+h/2, w*0.4, 0, Math.PI*2); ctx.fill();
      ctx.setLineDash([3, 3]);
      ctx.strokeStyle = '#999'; ctx.lineWidth = 1;
      ctx.strokeRect(m, m, w, h);
      ctx.setLineDash([]);
      break;
  }
  // Outer border
  ctx.strokeStyle = 'rgba(0,0,0,0.1)'; ctx.lineWidth = 1;
  ctx.strokeRect(m, m, w, h);
}

function onEditTypeChange() {
  const type = document.getElementById('editType').value;
  document.getElementById('editFinHWrap').style.display = (type === 'rect' || type === 'flygeese' || type === 'strip') ? '' : 'none';
  document.getElementById('editHst2').style.display = (type === 'hst' || type === 'qst') ? '' : 'none';
}

// ‚îÄ‚îÄ Piece Management ‚îÄ‚îÄ
function addPiece() {
  const type = document.getElementById('pieceType').value;
  const finW = parseFloat(document.getElementById('pieceFinW').value);
  const finH = (type === 'rect' || type === 'flygeese' || type === 'strip') ? parseFloat(document.getElementById('pieceFinH').value) : finW;
  const qty = parseInt(document.getElementById('pieceQty').value) || 1;
  const color = document.getElementById('pieceColor').value;
  const name = document.getElementById('pieceFabricName').value || 'Unnamed';

  const piece = { type, finW, finH, qty, color, name };

  if (type === 'hst' || type === 'qst') {
    piece.color2 = document.getElementById('pieceColor2').value;
    piece.name2 = document.getElementById('pieceFabricName2').value || 'Unnamed B';
  }

  blockPieces.push(piece);
  renderPiecesList();
}

function removePiece(i) {
  blockPieces.splice(i, 1);
  renderPiecesList();
}

function clearPieces() {
  blockPieces = [];
  renderPiecesList();
}

function randomizeColors() {
  if (blockPieces.length < 2) return;
  const colors = [];
  blockPieces.forEach(p => {
    colors.push({ color: p.color, name: p.name });
    if (p.color2) colors.push({ color: p.color2, name: p.name2 });
  });
  // Fisher-Yates shuffle
  for (let i = colors.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [colors[i], colors[j]] = [colors[j], colors[i]];
  }
  let ci = 0;
  blockPieces.forEach(p => {
    p.color = colors[ci].color; p.name = colors[ci].name; ci++;
    if (p.color2 !== undefined) { p.color2 = colors[ci].color; p.name2 = colors[ci].name; ci++; }
  });
  renderPiecesList();
  calculate();
}

function editPiece(i) {
  editingIndex = i;
  const p = blockPieces[i];
  document.getElementById('editType').value = p.type;
  document.getElementById('editFinW').value = p.finW;
  document.getElementById('editFinH').value = p.finH || p.finW;
  document.getElementById('editQty').value = p.qty;
  document.getElementById('editColor').value = p.color;
  document.getElementById('editName').value = p.name;
  document.getElementById('editColor2').value = p.color2 || '#9caf88';
  document.getElementById('editName2').value = p.name2 || '';
  onEditTypeChange();
  document.getElementById('editModal').classList.add('active');
}

function saveEdit() {
  if (editingIndex < 0) return;
  const type = document.getElementById('editType').value;
  const p = blockPieces[editingIndex];
  p.type = type;
  p.finW = parseFloat(document.getElementById('editFinW').value);
  p.finH = (type === 'rect' || type === 'flygeese' || type === 'strip') ? parseFloat(document.getElementById('editFinH').value) : p.finW;
  p.qty = parseInt(document.getElementById('editQty').value) || 1;
  p.color = document.getElementById('editColor').value;
  p.name = document.getElementById('editName').value || 'Unnamed';
  if (type === 'hst' || type === 'qst') {
    p.color2 = document.getElementById('editColor2').value;
    p.name2 = document.getElementById('editName2').value || 'Unnamed B';
  } else {
    delete p.color2;
    delete p.name2;
  }
  closeEditModal();
  renderPiecesList();
}

function closeEditModal() {
  editingIndex = -1;
  document.getElementById('editModal').classList.remove('active');
}

function renderPiecesList() {
  const list = document.getElementById('piecesList');
  if (blockPieces.length === 0) {
    list.innerHTML = '<p style="color:var(--muted);font-size:0.85rem;">No pieces yet ‚Äî add pieces above or load an example.</p>';
    return;
  }
  list.innerHTML = blockPieces.map((p, i) => {
    const typeLabel = { square: 'Square', rect: 'Rect', hst: 'HST', qst: 'QST', flygeese: 'Flying Geese', strip: 'Strip', circle: 'Circle' }[p.type];
    const dims = (p.type === 'square' || p.type === 'circle') ? `${fmtDim(p.finW)}‚Ä≥` : `${fmtDim(p.finW)}√ó${fmtDim(p.finH)}‚Ä≥`;
    const hstExtra = (p.type === 'hst' || p.type === 'qst') ? ` <span class="swatch" style="background:${p.color2};display:inline-block;vertical-align:middle;"></span> ${esc(p.name2)}` : '';
    return `<div class="piece-item">
      <div class="swatch" style="background:${p.color}"></div>
      <div class="dims">${typeLabel} ${dims} √ó${p.qty}</div>
      <div class="piece-name">${esc(p.name)}${hstExtra}</div>
      <button class="btn btn-sm btn-edit" onclick="editPiece(${i})" title="Edit piece">‚úé</button>
      <button class="btn btn-sm btn-danger" onclick="removePiece(${i})" title="Remove">‚úï</button>
    </div>`;
  }).join('');
}

function esc(s) { return String(s).replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

// ‚îÄ‚îÄ Cutting Math ‚îÄ‚îÄ
function cutSize(piece, seam) {
  const s = seam;
  switch (piece.type) {
    case 'square':
      return { w: piece.finW + 2*s, h: piece.finW + 2*s, note: `Cut ${fmtDim(piece.finW + 2*s)}‚Ä≥ square` };
    case 'rect':
      return { w: piece.finW + 2*s, h: piece.finH + 2*s, note: `Cut ${fmtDim(piece.finW + 2*s)}√ó${fmtDim(piece.finH + 2*s)}‚Ä≥` };
    case 'hst': {
      const hstCut = piece.finW + 0.875;
      return { w: hstCut, h: hstCut, yieldsTwo: true, note: `Cut ${fmtDim(hstCut)}‚Ä≥ sq, cut ‚ï≤ = 2 HSTs` };
    }
    case 'qst': {
      const qstCut = piece.finW + 1.25;
      return { w: qstCut, h: qstCut, yieldsFour: true, note: `Cut ${fmtDim(qstCut)}‚Ä≥ sq, cut ‚ï≥ = 4 QSTs` };
    }
    case 'flygeese': {
      const fgLg = piece.finW + 1.25;
      const fgSm = piece.finH + 0.875;
      return {
        w: fgLg, h: fgLg, smallW: fgSm, smallH: fgSm, yieldsFour: true,
        note: `Lg: ${fmtDim(fgLg)}‚Ä≥ sq (‚ï≥ = 4), Sm: ${fmtDim(fgSm)}‚Ä≥ sq (‚ï≤ = 2)`
      };
    }
    case 'strip': {
      return { w: piece.finW + 2*s, h: piece.finH + 2*s, isStrip: true, note: `Cut ${fmtDim(piece.finH + 2*s)}‚Ä≥ strip √ó WOF, sub-cut to ${fmtDim(piece.finW + 2*s)}‚Ä≥` };
    }
    case 'circle': {
      const diam = piece.finW + 0.75; // ‚Öú‚Ä≥ turn-under per side
      return { w: diam, h: diam, note: `Cut ${fmtDim(diam)}‚Ä≥ square for ${fmtDim(piece.finW)}‚Ä≥ appliqu√© circle` };
    }
    default:
      return { w: piece.finW + 2*s, h: piece.finW + 2*s, note: '' };
  }
}

function fmtDim(v) {
  const whole = Math.floor(v);
  const frac = v - whole;
  const fracs = [[0.125,'‚Öõ'],[0.25,'¬º'],[0.375,'‚Öú'],[0.5,'¬Ω'],[0.625,'‚Öù'],[0.75,'¬æ'],[0.875,'‚Öû']];
  if (Math.abs(frac) < 0.01) return `${whole}`;
  for (const [val, sym] of fracs) {
    if (Math.abs(frac - val) < 0.01) return whole > 0 ? `${whole}${sym}` : sym;
  }
  return v.toFixed(2);
}

function yardsToFraction(yards) {
  const eighths = Math.ceil(yards * 8);
  const whole = Math.floor(eighths / 8);
  const rem = eighths % 8;
  const fracs = ['','‚Öõ','¬º','‚Öú','¬Ω','‚Öù','¬æ','‚Öû'];
  if (rem === 0) return `${whole}`;
  return whole > 0 ? `${whole} ${fracs[rem]}` : fracs[rem];
}

// ‚îÄ‚îÄ Main Calculation ‚îÄ‚îÄ
function calculate() {
  if (blockPieces.length === 0) return alert('Add at least one piece to your block.');

  const quiltW = parseFloat(document.getElementById('quiltW').value);
  const quiltH = parseFloat(document.getElementById('quiltH').value);
  const blockSz = parseFloat(document.getElementById('blockSize').value);
  const seam = parseFloat(document.getElementById('seamAllowance').value);
  const wof = parseFloat(document.getElementById('wof').value);
  const sashW = parseFloat(document.getElementById('sashW').value) || 0;
  const borderW = parseFloat(document.getElementById('borderW').value) || 0;
  const bindingW = parseFloat(document.getElementById('bindingW').value) || 0;
  const calcBacking = document.getElementById('calcBacking').checked;
  const wastePct = (parseFloat(document.getElementById('wasteMargin').value) || 0) / 100;

  const innerW = quiltW - 2 * borderW;
  const innerH = quiltH - 2 * borderW;
  const cols = Math.max(1, Math.floor((innerW + sashW) / (blockSz + sashW)));
  const rows = Math.max(1, Math.floor((innerH + sashW) / (blockSz + sashW)));
  const totalBlocks = rows * cols;

  const fabrics = {};
  function getFabric(name, color) {
    const key = `${name}|||${color}`;
    if (!fabrics[key]) fabrics[key] = { name, color, cuts: [] };
    return fabrics[key];
  }

  // Block pieces
  blockPieces.forEach(piece => {
    const cs = cutSize(piece, seam);
    const totalQty = piece.qty * totalBlocks;

    if (piece.type === 'hst') {
      const squaresNeeded = Math.ceil(totalQty / 2);
      getFabric(piece.name, piece.color).cuts.push({ cutW: cs.w, cutH: cs.h, count: squaresNeeded, note: cs.note, pieceType: 'hst' });
      getFabric(piece.name2, piece.color2).cuts.push({ cutW: cs.w, cutH: cs.h, count: squaresNeeded, note: cs.note, pieceType: 'hst' });
    } else if (piece.type === 'qst') {
      const squaresNeeded = Math.ceil(totalQty / 4);
      getFabric(piece.name, piece.color).cuts.push({ cutW: cs.w, cutH: cs.h, count: squaresNeeded, note: cs.note, pieceType: 'qst' });
      getFabric(piece.name2, piece.color2).cuts.push({ cutW: cs.w, cutH: cs.h, count: squaresNeeded, note: cs.note, pieceType: 'qst' });
    } else if (piece.type === 'flygeese') {
      const lgNeeded = Math.ceil(totalQty / 4);
      const smNeeded = totalQty * 2;
      const fab = getFabric(piece.name, piece.color);
      fab.cuts.push({ cutW: cs.w, cutH: cs.h, count: lgNeeded, note: `Lg sq: ${fmtDim(cs.w)}‚Ä≥ (‚ï≥ = 4 geese)`, pieceType: 'flygeese-lg' });
      fab.cuts.push({ cutW: cs.smallW, cutH: cs.smallH, count: smNeeded, note: `Sm sq: ${fmtDim(cs.smallW)}‚Ä≥ (corners)`, pieceType: 'flygeese-sm' });
    } else {
      getFabric(piece.name, piece.color).cuts.push({ cutW: cs.w, cutH: cs.h, count: totalQty, note: cs.note, pieceType: piece.type });
    }
  });

  // Sashing
  if (sashW > 0) {
    const fab = getFabric(document.getElementById('sashFabricName').value || 'Sashing', document.getElementById('sashColor').value);
    const vertSash = rows * (cols - 1);
    if (vertSash > 0) fab.cuts.push({ cutW: sashW + 2*seam, cutH: blockSz + 2*seam, count: vertSash, note: `Vert sashing`, pieceType: 'sashing' });
    const horizSash = rows - 1;
    if (horizSash > 0) fab.cuts.push({ cutW: innerW, cutH: sashW + 2*seam, count: horizSash, note: `Horiz sashing`, pieceType: 'sashing' });
  }

  // Border
  if (borderW > 0) {
    const fab = getFabric(document.getElementById('borderFabricName').value || 'Border', document.getElementById('borderColor').value);
    const cutW = borderW + 2 * seam;
    fab.cuts.push({ cutW: quiltW, cutH: cutW, count: 2, note: `Top/bottom border`, pieceType: 'border' });
    fab.cuts.push({ cutW: cutW, cutH: quiltH, count: 2, note: `Side border`, pieceType: 'border' });
  }

  // Binding
  if (bindingW > 0) {
    const fab = getFabric(document.getElementById('bindingFabricName').value || 'Binding', document.getElementById('bindingColor').value);
    const perimeter = 2 * (quiltW + quiltH) + 12;
    const stripsNeeded = Math.ceil(perimeter / wof);
    fab.cuts.push({ cutW: wof, cutH: bindingW, count: stripsNeeded, note: `Binding strips (WOF)`, pieceType: 'binding' });
  }

  // Calculate yardage
  const fabricList = Object.values(fabrics).map(fab => {
    let totalStripInches = 0;
    fab.stripDetails = [];
    fab.cuts.forEach(cut => {
      const acrossWOF = Math.max(1, Math.floor(wof / cut.cutW));
      const strips = Math.ceil(cut.count / acrossWOF);
      const stripHeight = cut.cutH;
      totalStripInches += strips * stripHeight;
      const wider = cut.cutW > wof;
      fab.stripDetails.push({ ...cut, strips, stripHeight, acrossWOF, note: cut.note + (wider ? ' (wider than WOF)' : '') });
    });
    fab.totalInches = totalStripInches;
    const withWaste = totalStripInches * (1 + wastePct);
    fab.totalYards = withWaste / 36;
    fab.yardsDisplay = yardsToFraction(fab.totalYards);
    fab.rawYards = totalStripInches / 36;
    return fab;
  });

  // Backing
  let backingYards = null;
  if (calcBacking) {
    const backW = quiltW + 8, backH = quiltH + 8;
    const panels = backW <= wof ? 1 : Math.ceil(backW / wof);
    backingYards = Math.ceil(((backH * panels) / 36) * 8) / 8;
  }

  renderResults(quiltW, quiltH, blockSz, rows, cols, totalBlocks, sashW, borderW, fabricList, backingYards, seam, wastePct);
}

// ‚îÄ‚îÄ Rendering ‚îÄ‚îÄ
function renderResults(quiltW, quiltH, blockSz, rows, cols, totalBlocks, sashW, borderW, fabricList, backingYards, seam, wastePct) {
  const area = document.getElementById('resultArea');
  let html = '';

  // Stats
  html += `<div class="stats">
    <div class="stat"><div class="val">${cols}√ó${rows}</div><div class="lbl">Block Grid</div></div>
    <div class="stat"><div class="val">${totalBlocks}</div><div class="lbl">Total Blocks</div></div>
    <div class="stat"><div class="val">${quiltW}√ó${quiltH}‚Ä≥</div><div class="lbl">Quilt Size</div></div>
    <div class="stat"><div class="val">${fabricList.length}</div><div class="lbl">Fabrics</div></div>
  </div>`;

  // Block Preview
  html += `<div class="panel"><h2>üß± Block Preview</h2><div class="canvas-wrap"><canvas id="blockCanvas"></canvas></div></div>`;

  // Quilt Preview
  html += `<div class="panel"><h2>üñº Quilt Preview</h2><div class="canvas-wrap"><canvas id="quiltCanvas"></canvas></div></div>`;

  // Yardage Table
  html += `<div class="panel"><h2>üìä Fabric Yardage</h2>`;
  if (wastePct > 0) html += `<div class="waste-note">Includes ${Math.round(wastePct*100)}% waste margin for shrinkage and cutting errors.</div>`;
  html += `<table class="fabric-table">
    <thead><tr><th>Fabric</th><th></th><th>Yardage</th><th>Raw</th></tr></thead><tbody>`;
  fabricList.forEach(f => {
    html += `<tr>
      <td>${esc(f.name)}</td>
      <td><span style="display:inline-block;width:16px;height:16px;border-radius:3px;background:${f.color};vertical-align:middle;border:1px solid rgba(0,0,0,0.15);"></span></td>
      <td><strong>${f.yardsDisplay} yd</strong></td>
      <td style="color:var(--muted);">${yardsToFraction(f.rawYards)} yd</td>
    </tr>`;
  });
  if (backingYards !== null) {
    html += `<tr><td>Backing</td><td>‚Äî</td><td><strong>${yardsToFraction(backingYards)} yd</strong></td><td></td></tr>`;
  }
  html += `</tbody></table></div>`;

  // Cutting Instructions
  html += `<div class="panel"><h2>‚úÇÔ∏è Cutting Instructions</h2>`;
  fabricList.forEach(f => {
    html += `<h3 style="color:var(--accent);font-size:0.95rem;margin-top:12px;margin-bottom:8px;">
      <span style="display:inline-block;width:12px;height:12px;border-radius:2px;background:${f.color};vertical-align:middle;margin-right:6px;border:1px solid rgba(0,0,0,0.15);"></span>
      ${esc(f.name)}</h3>`;
    html += `<table class="fabric-table"><thead><tr><th>Cut</th><th>Size</th><th>Qty</th><th>Strips</th></tr></thead><tbody>`;
    f.stripDetails.forEach(d => {
      html += `<tr>
        <td>${d.note}</td>
        <td>${fmtDim(d.cutW)}√ó${fmtDim(d.cutH)}‚Ä≥</td>
        <td>${d.count}</td>
        <td>${d.strips} √ó ${fmtDim(d.stripHeight)}‚Ä≥ strip${d.strips > 1 ? 's' : ''}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
  });
  html += `</div>`;

  // Shopping List
  html += `<div class="panel"><h2>üõí Shopping List</h2>`;
  html += `<table class="fabric-table"><thead><tr><th>Fabric</th><th>Buy</th></tr></thead><tbody>`;
  fabricList.forEach(f => {
    html += `<tr><td><span style="display:inline-block;width:12px;height:12px;border-radius:2px;background:${f.color};vertical-align:middle;margin-right:6px;border:1px solid rgba(0,0,0,0.15);"></span>${esc(f.name)}</td><td><strong>${f.yardsDisplay} yd</strong></td></tr>`;
  });
  if (backingYards !== null) {
    html += `<tr><td>Backing</td><td><strong>${yardsToFraction(backingYards)} yd</strong></td></tr>`;
  }
  html += `</tbody></table></div>`;

  // Precut Compatibility
  html += `<div class="panel"><h2>üéÅ Precut Compatibility</h2>`;
  html += `<p style="font-size:0.85rem;color:#7a756e;margin-bottom:10px;">Can your pieces be cut from standard precut bundles?</p>`;
  html += `<table class="fabric-table"><thead><tr><th>Precut Format</th><th>Size</th><th>Compatible Pieces</th><th>Status</th></tr></thead><tbody>`;

  const precuts = [
    { name: 'Charm Pack', w: 5, h: 5 },
    { name: 'Layer Cake', w: 10, h: 10 },
    { name: 'Jelly Roll', w: 2.5, h: 42 },
    { name: 'Fat Quarter', w: 18, h: 22 },
    { name: 'Fat Eighth', w: 9, h: 22 },
  ];
  precuts.forEach(pc => {
    let compat = 0, total = blockPieces.length;
    const compatPieces = [];
    blockPieces.forEach(p => {
      const cs = cutSize(p, seam);
      const fits = (cs.w <= pc.w && cs.h <= pc.h) || (cs.w <= pc.h && cs.h <= pc.w);
      if (fits) { compat++; compatPieces.push(p.name); }
    });
    const pct = total > 0 ? Math.round(100 * compat / total) : 0;
    const status = pct === 100 ? '‚úÖ All fit' : pct >= 50 ? '‚ö†Ô∏è Partial' : '‚ùå Too large';
    const statusClass = pct === 100 ? 'color:#4a8c5c' : pct >= 50 ? 'color:#c87941' : 'color:#c0392b';
    html += `<tr><td>${pc.name}</td><td>${pc.w}√ó${pc.h}‚Ä≥</td><td>${compat}/${total} pieces</td><td style="${statusClass};font-weight:bold;">${status}</td></tr>`;
  });
  html += `</tbody></table></div>`;

  area.innerHTML = html;

  drawBlockPreviewLarge();
  drawQuiltPreview(quiltW, quiltH, blockSz, rows, cols, sashW, borderW);
}

function drawBlockPreviewLarge() {
  const canvas = document.getElementById('blockCanvas');
  if (!canvas) return;
  const size = 240;
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#f0ede8';
  ctx.fillRect(0, 0, size, size);
  drawBlockPreview(ctx, 0, 0, size, blockPieces);
}

function drawQuiltPreview(quiltW, quiltH, blockSz, rows, cols, sashW, borderW) {
  const canvas = document.getElementById('quiltCanvas');
  if (!canvas) return;
  const maxW = 600, maxH = 500;
  const scale = Math.min(maxW / quiltW, maxH / quiltH);
  const w = Math.round(quiltW * scale), h = Math.round(quiltH * scale);
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext('2d');

  const borderColor = document.getElementById('borderColor').value;
  ctx.fillStyle = borderW > 0 ? borderColor : '#e0ddd8';
  ctx.fillRect(0, 0, w, h);

  const bdr = borderW * scale, sash = sashW * scale, blk = blockSz * scale;
  if (sashW > 0) {
    ctx.fillStyle = document.getElementById('sashColor').value;
    ctx.fillRect(bdr, bdr, w - 2*bdr, h - 2*bdr);
  }

  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      drawBlockPreview(ctx, bdr + c*(blk+sash), bdr + r*(blk+sash), blk, blockPieces);
    }
  }

  if (borderW > 0) {
    ctx.strokeStyle = 'rgba(0,0,0,0.15)';
    ctx.lineWidth = 1;
    ctx.strokeRect(bdr, bdr, w - 2*bdr, h - 2*bdr);
  }
}

function drawBlockPreview(ctx, x, y, size, pieces) {
  if (pieces.length === 0) {
    ctx.fillStyle = '#e0ddd8';
    ctx.fillRect(x, y, size, size);
    return;
  }
  const n = pieces.reduce((s, p) => s + p.qty, 0);
  const gridSide = Math.ceil(Math.sqrt(n));
  const cellW = size / gridSide, cellH = size / gridSide;

  let idx = 0;
  pieces.forEach(piece => {
    for (let q = 0; q < piece.qty && idx < gridSide*gridSide; q++) {
      const col = idx % gridSide, row = Math.floor(idx / gridSide);
      const cx = x + col*cellW, cy = y + row*cellH;

      if (piece.type === 'hst') {
        ctx.fillStyle = piece.color;
        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx+cellW, cy); ctx.lineTo(cx, cy+cellH); ctx.closePath(); ctx.fill();
        ctx.fillStyle = piece.color2;
        ctx.beginPath(); ctx.moveTo(cx+cellW, cy); ctx.lineTo(cx+cellW, cy+cellH); ctx.lineTo(cx, cy+cellH); ctx.closePath(); ctx.fill();
      } else if (piece.type === 'qst') {
        const mx = cx+cellW/2, my = cy+cellH/2;
        ctx.fillStyle = piece.color;
        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(mx, my); ctx.lineTo(cx, cy+cellH); ctx.closePath(); ctx.fill();
        ctx.beginPath(); ctx.moveTo(cx+cellW, cy); ctx.lineTo(mx, my); ctx.lineTo(cx+cellW, cy+cellH); ctx.closePath(); ctx.fill();
        ctx.fillStyle = piece.color2;
        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx+cellW, cy); ctx.lineTo(mx, my); ctx.closePath(); ctx.fill();
        ctx.beginPath(); ctx.moveTo(cx, cy+cellH); ctx.lineTo(cx+cellW, cy+cellH); ctx.lineTo(mx, my); ctx.closePath(); ctx.fill();
      } else if (piece.type === 'flygeese') {
        ctx.fillStyle = piece.color;
        ctx.beginPath(); ctx.moveTo(cx+cellW/2, cy); ctx.lineTo(cx+cellW, cy+cellH); ctx.lineTo(cx, cy+cellH); ctx.closePath(); ctx.fill();
        ctx.fillStyle = '#e0ddd8';
        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx+cellW/2, cy); ctx.lineTo(cx, cy+cellH); ctx.closePath(); ctx.fill();
        ctx.beginPath(); ctx.moveTo(cx+cellW/2, cy); ctx.lineTo(cx+cellW, cy); ctx.lineTo(cx+cellW, cy+cellH); ctx.closePath(); ctx.fill();
      } else if (piece.type === 'strip') {
        ctx.fillStyle = piece.color;
        ctx.fillRect(cx, cy, cellW, cellH);
        ctx.strokeStyle = 'rgba(255,255,255,0.4)';
        ctx.lineWidth = 1;
        for (let i = 1; i < 3; i++) { ctx.beginPath(); ctx.moveTo(cx, cy+cellH*i/3); ctx.lineTo(cx+cellW, cy+cellH*i/3); ctx.stroke(); }
      } else if (piece.type === 'circle') {
        ctx.fillStyle = '#e0ddd8';
        ctx.fillRect(cx, cy, cellW, cellH);
        ctx.fillStyle = piece.color;
        ctx.beginPath(); ctx.arc(cx+cellW/2, cy+cellH/2, Math.min(cellW,cellH)*0.42, 0, Math.PI*2); ctx.fill();
      } else {
        ctx.fillStyle = piece.color;
        ctx.fillRect(cx, cy, cellW, cellH);
      }
      ctx.strokeStyle = 'rgba(0,0,0,0.1)';
      ctx.lineWidth = 0.5;
      ctx.strokeRect(cx, cy, cellW, cellH);
      idx++;
    }
  });
  while (idx < gridSide*gridSide) {
    const col = idx % gridSide, row = Math.floor(idx / gridSide);
    ctx.fillStyle = '#e8e5df';
    ctx.fillRect(x + col*cellW, y + row*cellH, cellW, cellH);
    idx++;
  }
}

// ‚îÄ‚îÄ Examples ‚îÄ‚îÄ
function loadExample(name) {
  const examples = {
    ninepatch: {
      quiltW: 50, quiltH: 65, blockSize: 9, sashW: 1.5, borderW: 3, bindingW: 2.5,
      pieces: [
        { type: 'square', finW: 3, finH: 3, qty: 5, color: '#5b8a8a', name: 'Teal' },
        { type: 'square', finW: 3, finH: 3, qty: 4, color: '#f5f0e6', name: 'Cream' },
      ]
    },
    pinwheel: {
      quiltW: 60, quiltH: 72, blockSize: 12, sashW: 2, borderW: 4, bindingW: 2.5,
      pieces: [
        { type: 'hst', finW: 6, finH: 6, qty: 4, color: '#c0392b', name: 'Red', color2: '#f5f0e6', name2: 'White' },
      ]
    },
    star: {
      quiltW: 68, quiltH: 90, blockSize: 12, sashW: 2, borderW: 4, bindingW: 2.5,
      pieces: [
        { type: 'square', finW: 3, finH: 3, qty: 1, color: '#c87941', name: 'Gold Center' },
        { type: 'hst', finW: 3, finH: 3, qty: 4, color: '#3d5a80', name: 'Navy Points', color2: '#f5f0e6', name2: 'Background' },
        { type: 'square', finW: 3, finH: 3, qty: 4, color: '#f5f0e6', name: 'Background' },
        { type: 'flygeese', finW: 6, finH: 3, qty: 4, color: '#3d5a80', name: 'Navy Points' },
      ]
    },
    railfence: {
      quiltW: 50, quiltH: 65, blockSize: 9, sashW: 0, borderW: 3, bindingW: 2.5,
      pieces: [
        { type: 'rect', finW: 9, finH: 3, qty: 1, color: '#5b8a8a', name: 'Teal' },
        { type: 'rect', finW: 9, finH: 3, qty: 1, color: '#c87941', name: 'Burnt Gold' },
        { type: 'rect', finW: 9, finH: 3, qty: 1, color: '#9caf88', name: 'Sage' },
      ]
    },
    logcabin: {
      quiltW: 60, quiltH: 72, blockSize: 12, sashW: 0, borderW: 3, bindingW: 2.5,
      pieces: [
        { type: 'square', finW: 3, finH: 3, qty: 1, color: '#c0392b', name: 'Red Center' },
        { type: 'rect', finW: 3, finH: 1.5, qty: 1, color: '#f5f0e6', name: 'Light 1' },
        { type: 'rect', finW: 4.5, finH: 1.5, qty: 1, color: '#f5f0e6', name: 'Light 1' },
        { type: 'rect', finW: 4.5, finH: 1.5, qty: 1, color: '#e8dcc8', name: 'Light 2' },
        { type: 'rect', finW: 6, finH: 1.5, qty: 1, color: '#e8dcc8', name: 'Light 2' },
        { type: 'rect', finW: 6, finH: 1.5, qty: 1, color: '#5b8a8a', name: 'Dark 1' },
        { type: 'rect', finW: 7.5, finH: 1.5, qty: 1, color: '#5b8a8a', name: 'Dark 1' },
        { type: 'rect', finW: 7.5, finH: 1.5, qty: 1, color: '#3d5a80', name: 'Dark 2' },
        { type: 'rect', finW: 9, finH: 1.5, qty: 1, color: '#3d5a80', name: 'Dark 2' },
      ]
    },
    irishchain: {
      quiltW: 72, quiltH: 90, blockSize: 12, sashW: 0, borderW: 4, bindingW: 2.5,
      pieces: [
        { type: 'square', finW: 2.4, finH: 2.4, qty: 13, color: '#5b8a8a', name: 'Teal' },
        { type: 'square', finW: 2.4, finH: 2.4, qty: 12, color: '#f5f0e6', name: 'Cream' },
      ]
    },
    bowtie: {
      quiltW: 60, quiltH: 72, blockSize: 10, sashW: 1, borderW: 3, bindingW: 2.5,
      pieces: [
        { type: 'square', finW: 5, finH: 5, qty: 2, color: '#9caf88', name: 'Sage' },
        { type: 'square', finW: 5, finH: 5, qty: 2, color: '#c87941', name: 'Burnt Gold' },
        { type: 'hst', finW: 5, finH: 5, qty: 0, color: '#9caf88', name: 'Sage', color2: '#c87941', name2: 'Burnt Gold' },
      ]
    },
    churn: {
      quiltW: 60, quiltH: 72, blockSize: 12, sashW: 2, borderW: 3, bindingW: 2.5,
      pieces: [
        { type: 'square', finW: 4, finH: 4, qty: 1, color: '#f5f0e6', name: 'Background' },
        { type: 'hst', finW: 4, finH: 4, qty: 4, color: '#5b8a8a', name: 'Teal', color2: '#f5f0e6', name2: 'Background' },
        { type: 'rect', finW: 4, finH: 2, qty: 4, color: '#5b8a8a', name: 'Teal' },
        { type: 'square', finW: 2, finH: 2, qty: 4, color: '#f5f0e6', name: 'Background' },
      ]
    },
    bear: {
      quiltW: 72, quiltH: 90, blockSize: 12, sashW: 2, borderW: 4, bindingW: 2.5,
      pieces: [
        { type: 'square', finW: 3, finH: 3, qty: 1, color: '#c87941', name: 'Gold Center' },
        { type: 'square', finW: 3, finH: 3, qty: 4, color: '#f5f0e6', name: 'Background' },
        { type: 'rect', finW: 3, finH: 1.5, qty: 4, color: '#5b4a3c', name: 'Brown' },
        { type: 'hst', finW: 1.5, finH: 1.5, qty: 16, color: '#5b4a3c', name: 'Brown', color2: '#f5f0e6', name2: 'Background' },
        { type: 'square', finW: 1.5, finH: 1.5, qty: 4, color: '#5b4a3c', name: 'Brown' },
      ]
    },
    ohio: {
      quiltW: 68, quiltH: 90, blockSize: 12, sashW: 2, borderW: 4, bindingW: 2.5,
      pieces: [
        { type: 'square', finW: 4, finH: 4, qty: 1, color: '#c87941', name: 'Gold Center' },
        { type: 'square', finW: 4, finH: 4, qty: 4, color: '#f5f0e6', name: 'Background' },
        { type: 'hst', finW: 4, finH: 4, qty: 4, color: '#5b8a8a', name: 'Teal', color2: '#f5f0e6', name2: 'Background' },
        { type: 'flygeese', finW: 8, finH: 4, qty: 4, color: '#5b8a8a', name: 'Teal' },
      ]
    },
    kaleidoscope: {
      quiltW: 60, quiltH: 72, blockSize: 12, sashW: 1, borderW: 3, bindingW: 2.5,
      pieces: [
        { type: 'qst', finW: 6, finH: 6, qty: 4, color: '#7b2d8e', name: 'Purple', color2: '#f5f0e6', name2: 'Background' },
        { type: 'square', finW: 6, finH: 6, qty: 0, color: '#f5f0e6', name: 'Background' },
      ]
    },
    stripgarden: {
      quiltW: 50, quiltH: 65, blockSize: 10, sashW: 0, borderW: 3, bindingW: 2.5,
      pieces: [
        { type: 'strip', finW: 10, finH: 2, qty: 1, color: '#5b8a8a', name: 'Teal' },
        { type: 'strip', finW: 10, finH: 2, qty: 1, color: '#c87941', name: 'Burnt Gold' },
        { type: 'strip', finW: 10, finH: 2, qty: 1, color: '#9caf88', name: 'Sage' },
        { type: 'strip', finW: 10, finH: 2, qty: 1, color: '#f5f0e6', name: 'Cream' },
        { type: 'strip', finW: 10, finH: 2, qty: 1, color: '#5b4a3c', name: 'Brown' },
      ]
    },
    modernapplique: {
      quiltW: 36, quiltH: 52, blockSize: 10, sashW: 2, borderW: 3, bindingW: 2.5,
      pieces: [
        { type: 'square', finW: 10, finH: 10, qty: 1, color: '#f5f0e6', name: 'Background' },
        { type: 'circle', finW: 6, finH: 6, qty: 1, color: '#c0392b', name: 'Red Circle' },
        { type: 'circle', finW: 3, finH: 3, qty: 2, color: '#9caf88', name: 'Sage Dots' },
      ]
    },
  };

  const ex = examples[name];
  if (!ex) return;
  document.getElementById('quiltW').value = ex.quiltW;
  document.getElementById('quiltH').value = ex.quiltH;
  document.getElementById('blockSize').value = ex.blockSize;
  document.getElementById('sashW').value = ex.sashW;
  document.getElementById('borderW').value = ex.borderW;
  document.getElementById('bindingW').value = ex.bindingW;
  blockPieces = ex.pieces.filter(p => p.qty > 0).map(p => ({ ...p }));
  renderPiecesList();
  calculate();
}

// ‚îÄ‚îÄ Import/Export ‚îÄ‚îÄ
function getProject() {
  return {
    version: 1,
    quiltW: parseFloat(document.getElementById('quiltW').value),
    quiltH: parseFloat(document.getElementById('quiltH').value),
    blockSize: parseFloat(document.getElementById('blockSize').value),
    seamAllowance: parseFloat(document.getElementById('seamAllowance').value),
    wof: parseFloat(document.getElementById('wof').value),
    wasteMargin: parseFloat(document.getElementById('wasteMargin').value),
    sashW: parseFloat(document.getElementById('sashW').value),
    sashColor: document.getElementById('sashColor').value,
    sashFabricName: document.getElementById('sashFabricName').value,
    borderW: parseFloat(document.getElementById('borderW').value),
    borderColor: document.getElementById('borderColor').value,
    borderFabricName: document.getElementById('borderFabricName').value,
    bindingW: parseFloat(document.getElementById('bindingW').value),
    bindingColor: document.getElementById('bindingColor').value,
    bindingFabricName: document.getElementById('bindingFabricName').value,
    calcBacking: document.getElementById('calcBacking').checked,
    pieces: blockPieces,
  };
}

function exportJSON() {
  const json = JSON.stringify(getProject(), null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'quiltplanner-project.json'; a.click();
  URL.revokeObjectURL(url);
}

function exportPDF() {
  calculate();
  window.print();
}

function showImportModal() {
  document.getElementById('importModal').classList.add('active');
  document.getElementById('importData').value = '';
  document.getElementById('importError').textContent = '';
}
function closeImportModal() { document.getElementById('importModal').classList.remove('active'); }

function doImport() {
  try {
    const data = JSON.parse(document.getElementById('importData').value);
    if (!data.pieces || !Array.isArray(data.pieces)) throw new Error('Invalid project format');
    document.getElementById('quiltW').value = data.quiltW || 50;
    document.getElementById('quiltH').value = data.quiltH || 65;
    document.getElementById('blockSize').value = data.blockSize || 12;
    document.getElementById('seamAllowance').value = data.seamAllowance || 0.25;
    document.getElementById('wof').value = data.wof || 42;
    document.getElementById('wasteMargin').value = data.wasteMargin || 10;
    document.getElementById('sashW').value = data.sashW || 0;
    document.getElementById('sashColor').value = data.sashColor || '#e8e0d4';
    document.getElementById('sashFabricName').value = data.sashFabricName || 'Sashing';
    document.getElementById('borderW').value = data.borderW || 0;
    document.getElementById('borderColor').value = data.borderColor || '#5b8a8a';
    document.getElementById('borderFabricName').value = data.borderFabricName || 'Border';
    document.getElementById('bindingW').value = data.bindingW || 2.5;
    document.getElementById('bindingColor').value = data.bindingColor || '#3a3632';
    document.getElementById('bindingFabricName').value = data.bindingFabricName || 'Binding';
    document.getElementById('calcBacking').checked = data.calcBacking !== false;
    blockPieces = data.pieces;
    renderPiecesList();
    closeImportModal();
    calculate();
  } catch (e) {
    document.getElementById('importError').textContent = 'Error: ' + e.message;
  }
}

// ‚îÄ‚îÄ Start ‚îÄ‚îÄ
init();
</script>
</body>
</html>
